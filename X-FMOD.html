<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-FMOD - X-Plane FMOD Toolkit by MACLine Dynamics</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-dark: #1e40af;
            --accent: #60a5fa;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;

            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #232938;
            --bg-card: #1e2533;
            --bg-hover: #252d3d;

            --border: #2d3748;
            --border-light: #374151;

            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
            --glow: 0 0 20px rgba(59, 130, 246, 0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .mode-selector {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .mode-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .mode-btn:hover {
            color: var(--text);
            background: var(--bg-hover);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .mode-description {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--border-light);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            position: relative;
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: var(--bg-tertiary);
            box-shadow: var(--glow);
        }

        .drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: var(--glow);
        }

        .drop-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .drop-subtext {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .file-info {
            background: var(--bg-tertiary);
            padding: 0.875rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border);
        }

        .file-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 1.25rem;
            line-height: 1;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 1.25rem 0 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: var(--primary);
            border-radius: 2px;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.625rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.625rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-light);
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            font-size: 0.875rem;
            cursor: pointer;
            flex: 1;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .checkbox-item input:checked+label {
            color: var(--text);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text);
            transition: all 0.2s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow), 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary-dark) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(59, 130, 246, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            box-shadow: var(--shadow), 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(16, 185, 129, 0.3);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .console {
            background: #0a0e14;
            color: #e5e9f0;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 1rem;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .console-line {
            margin-bottom: 0.25rem;
            opacity: 0;
            animation: fadeInConsole 0.3s ease-out forwards;
        }

        @keyframes fadeInConsole {
            to {
                opacity: 1;
            }
        }

        /* ... existing styles ... */

        .sound-entry.completed {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .sound-entry.completed .entry-header {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .bulk-actions {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            animation: slideIn 0.3s ease-out;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 0.6rem 0.8rem 0.6rem 2.2rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .search-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .entry-select-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 1rem;
            cursor: pointer;
            accent-color: var(--primary);
        }


        .console-line.success {
            color: #a3be8c;
        }

        .console-line.error {
            color: #bf616a;
        }

        .console-line.warning {
            color: #ebcb8b;
        }

        .console-line.info {
            color: #88c0d0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.875rem;
            margin-bottom: 1.25rem;
        }

        .stat {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat:hover {
            border-color: var(--primary);
            box-shadow: var(--glow);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.375rem;
        }

        .hidden {
            display: none;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border-radius: 50%;
            font-size: 0.65rem;
            cursor: help;
            margin-left: 0.375rem;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .info-icon:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        footer {
            text-align: center;
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: slideIn 0.4s ease-out backwards;
        }

        .card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .card:nth-child(4) {
            animation-delay: 0.2s;
        }

        /* Review Modal Styles */
        .review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            overflow-y: auto;
        }

        /* Compare Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            animation: fadeIn 0.2s ease-out forwards;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Compare Table Styles */
        .compare-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }

        .compare-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .compare-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .compare-row:hover td {
            background: var(--bg-hover);
        }

        .compare-row.deselected td {
            opacity: 0.5;
        }

        .compare-row.deselected td input {
            text-decoration: none;
        }

        .diff-old {
            color: #bf616a;
            margin-right: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .diff-new {
            color: #a3be8c;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .review-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .review-container {
            max-width: 1400px;
            width: 100%;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            margin: auto;
        }

        .review-header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 2rem;
            border-bottom: 1px solid var(--border);
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .review-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .review-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .review-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .review-body {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .sound-entry {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            position: relative;
        }

        .sound-entry:hover {
            border-color: var(--primary);
            box-shadow: var(--glow);
        }

        .sound-entry.deleted {
            opacity: 0.5;
            background: var(--bg-tertiary);
            border-color: var(--danger);
        }

        .sound-entry.deleted::after {
            content: 'DELETED';
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            z-index: 5;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .entry-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
            flex: 1;
        }

        .entry-controls {
            display: flex;
            gap: 0.5rem;
        }

        .entry-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text);
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .entry-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .entry-btn.delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .entry-btn.delete:hover {
            background: var(--danger);
            color: white;
        }

        .entry-btn.restore {
            border-color: var(--success);
            color: var(--success);
        }

        .entry-btn.restore:hover {
            background: var(--success);
            color: white;
        }

        .entry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .entry-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .entry-field.full-width {
            grid-column: 1 / -1;
        }

        .entry-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .entry-input,
        .entry-select {
            padding: 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .entry-input:focus,
        .entry-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .entry-checkbox-group {
            display: flex;
            gap: 1rem;
        }

        .entry-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
        }

        .entry-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .entry-checkbox label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
        }

        .category-chip {
            display: inline-flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 4px 12px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text);
            user-select: none;
        }

        .category-chip:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        .review-footer {
            background: var(--bg-secondary);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .review-stats {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .review-stats strong {
            color: var(--accent);
            font-size: 1rem;
        }

        .review-footer-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* X-FMOD Branding Styles */
        .beta-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(96, 165, 250, 0.1) 100%);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow), 0 0 30px rgba(59, 130, 246, 0.15);
            position: relative;
            overflow: hidden;
        }

        .beta-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .beta-badge-large {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            flex-shrink: 0;
        }

        .beta-text {
            flex: 1;
        }

        .beta-subtext {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .xfmod-title {
            background: linear-gradient(135deg, #e8e8e8 0%, #ffffff 25%, #c0c0c0 50%, #ffffff 75%, #e8e8e8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
            display: inline-block;
            margin: 0;
        }

        h1.xfmod-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .macline-credit {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .review-customize-badge {
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            color: #1e1e1e;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            display: inline-block;
            margin-left: 0.5rem;
        }

        /* Compare Modal Styles */
        .compare-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .compare-table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .compare-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .compare-row.deselected {
            opacity: 0.5;
        }

        .compare-row:hover {
            background: var(--bg-tertiary);
        }

        .diff-old {
            color: var(--error);
            text-decoration: line-through;
            font-size: 0.8em;
            display: block;
        }

        .diff-new {
            color: var(--success);
            font-weight: 500;
            display: block;
        }

        /* Modal Footer Actions */
        .modal-footer-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Resources & Help Hub Styles */
        .resource-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.25rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .resource-item:hover {
            border-color: var(--primary);
            background: var(--bg-secondary);
            transform: translateX(8px);
            box-shadow: var(--shadow);
        }

        .resource-item::after {
            content: '↗';
            position: absolute;
            right: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.3s;
            color: var(--primary);
            font-size: 1.25rem;
        }

        .resource-item:hover::after {
            opacity: 1;
            right: 1.5rem;
        }

        .resource-icon {
            font-size: 1.75rem;
            width: 50px;
            height: 50px;
            background: var(--bg-secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .resource-item:hover .resource-icon {
            border-color: var(--primary);
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }

        .resource-name {
            font-weight: 700;
            color: var(--text);
            font-size: 1.05rem;
            margin-bottom: 0.25rem;
        }

        .resource-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .tutorial-card {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-card) 100%);
            padding: 2rem;
            border-radius: 14px;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.4s ease;
        }

        .tutorial-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        .tutorial-tag {
            display: inline-block;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            margin-bottom: 1.25rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .tutorial-title {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text);
            line-height: 1.3;
        }

        .tutorial-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1.75rem;
            line-height: 1.6;
        }

        .tutorial-link {
            display: inline-block;
            color: var(--accent);
            text-decoration: none;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .tutorial-link:hover {
            color: var(--primary);
            letter-spacing: 0.05em;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Beta Banner -->
        <div class="beta-banner">
            <img src="icon.png" alt="X-FMOD Logo" style="height: 48px; width: auto; margin-right: 1rem;">
            <div class="beta-badge-large">BETA</div>
            <div class="beta-text">
                <strong class="xfmod-title">X-FMOD</strong>
                <div class="macline-credit">By MACLine Dynamics</div>
            </div>
            <div class="beta-subtext">
                X-Plane FMOD sound toolkit for aircraft developers • Version 0.4 Beta
            </div>
        </div>

        <header>
            <div class="mode-selector">
                <button class="mode-btn active" onclick="switchMode('generate')" id="generateModeBtn">
                    <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        Generate New File
                        <span class="review-customize-badge">REVIEW & EDIT</span>
                    </span>
                </button>
                <button class="mode-btn" onclick="switchMode('update')" id="updateModeBtn">
                    Update XYZ Coordinates
                </button>
                <button class="mode-btn" onclick="switchMode('fmod')" id="fmodModeBtn">
                    Resources & Help
                </button>
            </div>

            <div class="mode-description" id="modeDescription">
                Generate a complete .snd file from cockpit.obj manipulators with template sound blocks. The
                SND file requires a lot of hand crafted customization, but this tool will give you a big head
                start by parsing your cockpit.obj and letting you customize the final output. I would recommend
                using a less generic naming convention. More custom actions will likely come in future builds.
            </div>
        </header>

        <!-- GENERATE MODE CONTENT -->
        <div id="generateContent">
            <div class="grid">
                <!-- File Upload Section -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Input Files</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cockpit OBJ File *</label>
                        <div class="drop-zone" id="objDropZone">
                            <div class="drop-text">Drop cockpit.obj here</div>
                            <div class="drop-subtext">or click to browse files</div>
                        </div>
                        <input type="file" id="objFile" accept=".obj" style="display: none;">
                        <div id="objFileInfo" class="hidden"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Template SND File (Optional)</label>
                        <div class="drop-zone" id="templateDropZone">
                            <div class="drop-text">Drop template.snd here</div>
                            <div class="drop-subtext">preserves custom headers</div>
                        </div>
                        <input type="file" id="templateFile" accept=".snd" style="display: none;">
                        <div id="templateFileInfo" class="hidden"></div>
                    </div>
                </div>

                <!-- Options Section -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Generation Options</span>
                    </div>

                    <div class="form-group">
                        <div class="info-label">
                            <label class="form-label" for="parentCategory">Parent Category (Root)</label>
                            <span class="info-icon"
                                title="The root folder for your FMOD events (default: aircraft)">?</span>
                        </div>
                        <input type="text" id="parentCategory" value="aircraft" placeholder="e.g. B737, C172, MyPlane">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="eventName">Default Event Name</label>
                        <select id="eventName">
                            <option value="/aircraft/generic/switch">Generic Switch</option>
                            <option value="/aircraft/generic/knob">Generic Knob</option>
                            <option value="/aircraft/generic/button">Generic Button</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>

                    <div class="form-group hidden" id="customEventGroup">
                        <label class="form-label" for="customEventName">Custom Event Path</label>
                        <input type="text" id="customEventName" placeholder="/myaircraft/sounds/switch">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="outputName">Output Filename</label>
                        <input type="text" id="outputName" value="generated_sounds.snd">
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="useHoldCue" checked>
                        <label for="useHoldCue">Use EVENT_CMND_HOLD_CUE</label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="duplicateForRelease">
                        <label for="duplicateForRelease">Duplicate for Button Release</label>
                        <span class="info-icon" title="Creates press and release sounds for realistic feedback">?</span>
                    </div>
                </div>

                <!-- Manipulator Filters -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Manipulator Filters</span>
                    </div>

                    <div class="section-title">Exclude Manipulator Types</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="excludeDragAxis" checked>
                            <label for="excludeDragAxis">Drag Axis</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="excludeDragXY">
                            <label for="excludeDragXY">Drag XY</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="excludeAxisKnob">
                            <label for="excludeAxisKnob">Axis Knob</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="excludeNoop">
                            <label for="excludeNoop">No-op</label>
                        </div>
                    </div>

                    <div class="form-group"
                        style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                        <label class="form-label">Category Creation</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                            <input type="text" id="categoryInput" class="entry-input" placeholder="e.g. switches"
                                style="flex:1;">
                            <button class="btn btn-secondary" onclick="addCategory()"
                                style="width: 50px; padding: 0.6rem 0; white-space: nowrap; height: fit-content; text-align: center;">ADD</button>
                        </div>
                        <div id="categoryList" style="min-height: 20px; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- Categories will appear here -->
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
                            Create custom groups to organize your sounds. You can assign these in the review step.
                        </div>
                    </div>
                </div>

                <!-- Template Sounds -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Template Sound Blocks</span>
                    </div>

                    <div class="section-title">Engine & Propulsion</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeEngine" checked>
                            <label for="includeEngine">Engine</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includePropeller" checked>
                            <label for="includePropeller">Propeller</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeJet">
                            <label for="includeJet">Jet Engine</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeReverser">
                            <label for="includeReverser">Reversers</label>
                        </div>
                    </div>

                    <div class="section-title">Landing Gear & Ground</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeGear" checked>
                            <label for="includeGear">Gear Extension</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeTires" checked>
                            <label for="includeTires">Tire Squeal</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeGroundRoll">
                            <label for="includeGroundRoll">Ground Roll</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeBrakes">
                            <label for="includeBrakes">Brakes</label>
                        </div>
                    </div>

                    <div class="section-title">Flight Controls</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeFlaps">
                            <label for="includeFlaps">Flaps</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeSpoilers">
                            <label for="includeSpoilers">Spoilers</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeTrimWheel">
                            <label for="includeTrimWheel">Trim Wheel</label>
                        </div>
                    </div>

                    <div class="section-title">Warnings & Environment</div>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeStallWarning">
                            <label for="includeStallWarning">Stall Warning</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeGearWarning">
                            <label for="includeGearWarning">Gear Warning</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeOverspeed">
                            <label for="includeOverspeed">Overspeed</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeMasterWarning">
                            <label for="includeMasterWarning">Master Warn</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeWind">
                            <label for="includeWind">Wind Noise</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeRain">
                            <label for="includeRain">Rain</label>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="card full-width">
                    <button class="btn" id="generateBtn" onclick="generateSND()">
                        Generate .SND File
                    </button>
                    <div class="progress-bar hidden" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <!-- Output Section -->
                <div class="card full-width hidden" id="outputSection">
                    <div class="card-header">
                        <span class="card-title">Generation Results</span>
                    </div>

                    <div class="stats hidden" id="statsGrid">
                        <div class="stat">
                            <div class="stat-value" id="statVertices">0</div>
                            <div class="stat-label">Vertices</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statManipulators">0</div>
                            <div class="stat-label">Found</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statFiltered">0</div>
                            <div class="stat-label">Filtered</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statDuplicated">0</div>
                            <div class="stat-label">With Release</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statTemplates">0</div>
                            <div class="stat-label">Templates</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statTime">0ms</div>
                            <div class="stat-label">Time</div>
                        </div>
                    </div>

                    <div class="console" id="console"></div>

                    <button class="btn btn-success hidden" id="downloadBtn">
                        Download .SND File
                    </button>
                </div>
            </div>
        </div>

        <!-- UPDATE MODE CONTENT -->
        <div id="updateContent" class="hidden">
            <div class="grid">
                <!-- File Upload Section for Update Mode -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Input Files</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cockpit OBJ File *</label>
                        <div class="drop-zone" id="objDropZoneUpdate">
                            <div class="drop-text">Drop cockpit.obj here</div>
                            <div class="drop-subtext">source for XYZ coordinates</div>
                        </div>
                        <input type="file" id="objFileUpdate" accept=".obj" style="display: none;">
                        <div id="objFileInfoUpdate" class="hidden"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Existing SND File *</label>
                        <div class="drop-zone" id="sndDropZone">
                            <div class="drop-text">Drop your .snd file here</div>
                            <div class="drop-subtext">will be updated with correct coordinates</div>
                        </div>
                        <input type="file" id="sndFile" accept=".snd" style="display: none;">
                        <div id="sndFileInfo" class="hidden"></div>
                    </div>
                </div>

                <!-- Options for Update Mode -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Update Options</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="outputNameUpdate">Output Filename</label>
                        <input type="text" id="outputNameUpdate" value="updated_sounds.snd">
                    </div>

                    <div
                        style="padding: 1rem; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid var(--warning);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <strong style="color: var(--warning);">How it works:</strong>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.6;">
                            The tool matches commands in your .snd file with manipulators in the cockpit.obj and updates
                            the VEH_XYZ coordinates. This fixes the Y/Z axis flip between Blender and X-Plane
                            automatically.
                        </div>
                    </div>
                </div>

                <!-- Update Button -->
                <div class="card full-width">
                    <button class="btn" id="updateBtn" onclick="updateXYZ()">
                        Update XYZ Coordinates
                    </button>
                    <div class="progress-bar hidden" id="progressBarUpdate">
                        <div class="progress-fill" id="progressFillUpdate"></div>
                    </div>
                </div>

                <!-- Update Output Section -->
                <div class="card full-width hidden" id="outputSectionUpdate">
                    <div class="card-header">
                        <span class="card-title">Update Results</span>
                    </div>

                    <div class="stats hidden" id="statsGridUpdate">
                        <div class="stat">
                            <div class="stat-value" id="statEntriesFound">0</div>
                            <div class="stat-label">Entries in SND</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statMatched">0</div>
                            <div class="stat-label">Matched</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statUpdated">0</div>
                            <div class="stat-label">Updated</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statUnmatched">0</div>
                            <div class="stat-label">Not Found</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="statTimeUpdate">0ms</div>
                            <div class="stat-label">Time</div>
                        </div>
                    </div>

                    <div class="console" id="consoleUpdate"></div>

                    <button class="btn btn-success hidden" id="downloadBtnUpdate">
                        Download Updated .SND File
                    </button>
                </div>
            </div>
        </div>

        <!-- COMPARE MODAL -->
        <div id="compareModal" class="modal-overlay">
            <div class="modal" style="max-width: 900px;">
                <div class="modal-header">
                    <span class="modal-title">Compare & Finalize Updates</span>
                    <button class="modal-close" onclick="closeCompareModal()">×</button>
                </div>

                <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Coordinate Changes Found</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                Review the proposed coordinate updates below. Uncheck any changes you wish to discard.
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);"
                                id="compareTotalChanges">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Changes Detected</div>
                        </div>
                    </div>
                </div>

                <div class="modal-body" style="padding: 0;">
                    <table class="compare-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="compareSelectAll" checked
                                        onclick="toggleAllCompare(this.checked)">
                                </th>
                                <th>Command / Event</th>
                                <th>Coordinates (XYZ)</th>
                            </tr>
                        </thead>
                        <tbody id="compareBody">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>

                <div class="modal-footer modal-footer-actions">
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        <span id="compareSelectedCount">0</span> changes selected
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn secondary" onclick="closeCompareModal()">Cancel</button>
                        <button class="btn btn-success" onclick="applyUpdates()">Finalize Update</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESOURCES & HELP MODE -->
        <div id="fmodContent" class="hidden">
            <div class="grid">
                <!-- Official Documentation Section -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Official Documentation</span>
                    </div>
                    <div class="resource-list">
                        <a href="https://developer.x-plane.com/docs/sound/" target="_blank" class="resource-item">
                            <div class="resource-icon">📖</div>
                            <div class="resource-info">
                                <div class="resource-name">X-Plane FMOD Guide</div>
                                <div class="resource-desc">The official "Getting Started" guide for X-Plane developers.
                                </div>
                            </div>
                        </a>
                        <a href="https://fmod.com/docs/2.02/studio/welcome-to-fmod-studio.html" target="_blank"
                            class="resource-item">
                            <div class="resource-icon">📚</div>
                            <div class="resource-info">
                                <div class="resource-name">FMOD Studio Manual</div>
                                <div class="resource-desc">Complete user manual for the FMOD Studio application.</div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Essential Tools Section -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Essential Tools</span>
                    </div>
                    <div class="resource-list">
                        <a href="https://fmod.com/download" target="_blank" class="resource-item">
                            <div class="resource-icon">🛠️</div>
                            <div class="resource-info">
                                <div class="resource-name">FMOD Studio Download</div>
                                <div class="resource-desc">Download FMOD Studio 2.02.x (required for X-Plane).</div>
                            </div>
                        </a>
                        <a href="#" onclick="alert('Stay tuned! Detailed documentation for X-FMOD is coming soon.')"
                            class="resource-item">
                            <div class="resource-icon">🛸</div>
                            <div class="resource-info">
                                <div class="resource-name">X-FMOD Usage Guide</div>
                                <div class="resource-desc">Internal guide on how to use all X-FMOD features.</div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Community & Tutorials Section -->
                <div class="card full-width">
                    <div class="card-header">
                        <span class="card-title">Community & Tutorials</span>
                    </div>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                        <div class="tutorial-card">
                            <div class="tutorial-tag">VIDEO</div>
                            <h3 class="tutorial-title">FMOD Workflow in X-Plane</h3>
                            <p class="tutorial-desc">Learn the basic workflow from cockpit.obj to FMOD project and .snd
                                file.</p>
                            <a href="https://www.youtube.com/results?search_query=x-plane+fmod+tutorial" target="_blank"
                                class="tutorial-link">Search Tutorials →</a>
                        </div>
                        <div class="tutorial-card">
                            <div class="tutorial-tag">FORUM</div>
                            <h3 class="tutorial-title">X-Plane.org Developer Forum</h3>
                            <h3 class="tutorial-title"></h3>
                            <p class="tutorial-desc">Ask questions and share advice with fellow X-Plane sound designers.
                            </p>
                            <a href="https://forums.x-plane.org/forums/forum/99-sound-engineering-in-x-plane/"
                                target="_blank" class="tutorial-link">Visit Forum →</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review & Customize Modal -->
        <div class="review-modal" id="reviewModal">
            <div class="review-container">
                <div class="review-header">
                    <h2>Review & Customize Sound Configuration</h2>
                    <p>Edit event names, triggers, and conditions. Delete unwanted entries. Click on any field to
                        customize.</p>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <div class="search-box">
                            <span class="search-icon">🔍</span>
                            <input type="text" class="search-input" placeholder="Search events..."
                                oninput="updateSearch(this.value)">
                        </div>
                        <div class="review-filters">
                            <button class="filter-btn active" onclick="filterEntries('all')">All (<span
                                    id="countAll">0</span>)</button>
                            <button class="filter-btn" onclick="filterEntries('pending')">Pending (<span
                                    id="countPending">0</span>)</button>
                            <button class="filter-btn" onclick="filterEntries('completed')">Complete (<span
                                    id="countCompleted">0</span>)</button>
                            <button class="filter-btn" onclick="filterEntries('template')">Templates (<span
                                    id="countTemplate">0</span>)</button>
                            <button class="filter-btn" onclick="filterEntries('manip')">Manipulators (<span
                                    id="countManip">0</span>)</button>
                            <button class="filter-btn" onclick="filterEntries('deleted')">Deleted (<span
                                    id="countDeleted">0</span>)</button>
                        </div>
                    </div>

                    <div class="bulk-actions hidden" id="bulkActionsPanel">
                        <div style="font-weight: 600; font-size: 0.9rem; margin-right: auto;">
                            <span id="selectedCount">0</span> Selected
                        </div>

                        <select class="entry-select" id="bulkCategory" style="width: 150px;">
                            <option value="">Set Category...</option>
                            <option value="generic">Generic</option>
                            <!-- filled dynamically -->
                        </select>

                        <select class="entry-select" id="bulkTrigger" style="width: 180px;">
                            <option value="">Set Trigger...</option>
                            <option value="EVENT_START_COND">Start/End Condition</option>
                            <option value="EVENT_CMND_DOWN">Command Pressed</option>
                            <option value="EVENT_CMND_UP">Command Released</option>
                            <option value="EVENT_CMND_HOLD_STOP">Hold to Play</option>
                            <option value="EVENT_CMND_HOLD_CUE">Press & Release Cue</option>
                            <option value="CUE_TRIGGER_COND">Cue Trigger</option>
                        </select>

                        <button class="btn btn-secondary" onclick="applyBulkUpdate()"
                            style="padding: 0.5rem 1rem; width: auto;">Apply</button>
                    </div>
                </div>

                <div class="review-body" id="reviewBody">
                    <!-- Entries will be inserted here -->
                </div>

                <div class="review-footer">
                    <div class="review-stats">
                        Total: <strong id="totalEntries">0</strong> entries |
                        Active: <strong id="activeEntries">0</strong> |
                        Deleted: <strong id="deletedEntries">0</strong>
                    </div>
                    <div class="review-footer-actions">
                        <button class="btn btn-secondary" onclick="closeReviewModal()">Cancel</button>
                        <button class="btn" onclick="downloadReviewedSND()">Download .SND File</button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div style="margin-bottom: 0.75rem;">
                <span class="xfmod-title" style="font-size: 1rem;">X-FMOD</span> by <strong>MACLine Dynamics</strong> •
                Professional X-Plane FMOD Toolkit • Version 0.4 (Beta)
            </div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">
                Report any issues to <a href="mailto:maclinedynamics@gmail.com"
                    style="color: var(--primary); text-decoration: none;">maclinedynamics@gmail.com</a>
            </div>
        </footer>
    </div>

    <script>
        // Global state
        let objFileContent = null;
        let templateFileContent = null;
        let generatedContent = null;
        let currentMode = 'generate';


        // Review system state
        let soundEntries = [];
        let currentFilter = 'all';
        let nextEntryId = 1;
        let currentDiffs = [];
        let currentFilename = 'aircraft_sounds.snd';
        let userCategories = [];
        let searchText = '';

        // ========================================================================
        // CLASS DEFINITIONS
        // ========================================================================

        class SoundEntry {
            constructor(data) {
                this.id = data.id || `entry_${nextEntryId++}`;
                this.eventName = data.eventName || '/aircraft/sound';
                this.triggerType = data.triggerType || 'EVENT_START_COND';
                this.startCond = data.startCond || '';
                this.endCond = data.endCond || '';
                this.command = data.command || '';
                this.cueTrigger = data.cueTrigger || '';
                this.autoEndCond = data.autoEndCond || '';
                this.xyz = data.xyz || [0, 0, 0];
                this.polyphonic = data.polyphonic || false;
                this.allowedForAI = data.allowedForAI || false;
                this.deleted = false;
                this.vehPart = data.vehPart || null;
                this.paramDrefIdx = data.paramDrefIdx !== undefined ? data.paramDrefIdx : null;
                this.isTemplate = data.isTemplate || false;
                this.comment = data.comment || '';
                this.completed = data.completed || false;
                this.selected = false;
            }

            toSND() {
                if (this.deleted) return '';

                let output = '';

                if (this.comment) {
                    output += `# ${this.comment}\n`;
                }

                output += 'BEGIN_SOUND_ATTACHMENT\n';
                output += `\tEVENT_NAME ${this.eventName}\n`;

                if (this.vehPart) {
                    output += `\tVEH_PART ${this.vehPart}\n`;
                } else {
                    output += `\tVEH_XYZ ${this.xyz[0].toFixed(3)} ${this.xyz[1].toFixed(3)} ${this.xyz[2].toFixed(3)}\n`;
                }

                if (this.polyphonic) {
                    output += `\tEVENT_POLYPHONIC\n`;
                }

                if (this.allowedForAI) {
                    output += `\tEVENT_ALLOWED_FOR_AI\n`;
                }

                if (this.paramDrefIdx !== null) {
                    output += `\tPARAM_DREF_IDX ${this.paramDrefIdx}\n`;
                }

                switch (this.triggerType) {
                    case 'EVENT_START_COND':
                        if (this.startCond) output += `\tEVENT_START_COND ${this.startCond}\n`;
                        if (this.endCond) output += `\tEVENT_END_COND ${this.endCond}\n`;
                        break;
                    case 'EVENT_CMND_DOWN':
                        if (this.command) output += `\tEVENT_CMND_DOWN ${this.command}\n`;
                        break;
                    case 'EVENT_CMND_UP':
                        if (this.command) output += `\tEVENT_CMND_UP ${this.command}\n`;
                        break;
                    case 'EVENT_CMND_HOLD_STOP':
                        if (this.command) output += `\tEVENT_CMND_HOLD_STOP ${this.command}\n`;
                        break;
                    case 'EVENT_CMND_HOLD_CUE':
                        if (this.command) output += `\tEVENT_CMND_HOLD_CUE ${this.command}\n`;
                        break;
                    case 'CUE_TRIGGER_COND':
                        if (this.cueTrigger) output += `\tCUE_TRIGGER_COND ${this.cueTrigger}\n`;
                        break;
                }

                if (this.autoEndCond) {
                    output += `\tEVENT_AUTO_END_FROM_START_COND ${this.autoEndCond}\n`;
                }

                output += 'END_SOUND_ATTACHMENT\n\n';
                return output;
            }
        }

        class OBJParser {
            constructor(content) {
                this.content = content;
                this.vertices = [];
                this.manipulators = [];
            }

            parse() {
                const lines = this.content.split('\n');

                for (const line of lines) {
                    if (line.startsWith('VT\t') || line.startsWith('VT ')) {
                        this.parseVertex(line);
                    }
                }

                let currentVertexOffset = 0;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (line.startsWith('TRIS')) {
                        const parts = line.split(/\s+/);
                        if (parts.length >= 2) {
                            currentVertexOffset = parseInt(parts[1]) || 0;
                        }
                    }

                    if (line.includes('ATTR_manip') && !line.includes('ATTR_manip_none')) {
                        const manip = this.parseManipulator(line, i + 1);
                        if (manip && currentVertexOffset < this.vertices.length) {
                            manip.xyz = this.vertices[currentVertexOffset];
                            this.manipulators.push(manip);
                        }
                    }
                }

                return {
                    vertices: this.vertices,
                    manipulators: this.manipulators
                };
            }

            parseVertex(line) {
                const parts = line.split(/\s+/);
                if (parts.length >= 4) {
                    const x = parseFloat(parts[1]);
                    const y = parseFloat(parts[2]);
                    const z = parseFloat(parts[3]);
                    if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                        this.vertices.push([x, y, z]);
                    }
                }
            }

            parseManipulator(line, lineNum) {
                const parts = line.split('\t').filter(p => p.trim());

                if (parts.length < 3) return null;

                const manipType = parts[0].replace('ATTR_manip_', '');
                const cursor = parts[1] || 'hand';
                const command = parts[2] || '';
                const tooltip = parts[3] || '';

                return {
                    manipType,
                    cursor,
                    command,
                    tooltip,
                    xyz: [0, 0, 0],
                    lineNumber: lineNum
                };
            }
        }

        class SNDUpdater {
            constructor(sndContent) {
                this.content = sndContent;
                this.originalLines = sndContent.split('\n');
            }

            // identifyChanges returns a list of proposed updates
            identifyChanges(commandMap) {
                const lines = [...this.originalLines]; // Copy
                let changes = [];
                let currentCommand = null;
                let currentEventName = 'Unknown Event';
                let pendingXYZLineIndex = null;
                let unmatched = [];

                // Stats
                let totalEntries = 0;
                let matched = 0;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmed = line.trim();

                    // Track when we enter a sound attachment block
                    if (trimmed === 'BEGIN_SOUND_ATTACHMENT') {
                        totalEntries++;
                        currentCommand = null;
                        currentEventName = 'Unknown Event';
                        pendingXYZLineIndex = null;
                    }

                    // Track Event Name
                    if (trimmed.startsWith('EVENT_NAME ')) {
                        currentEventName = trimmed.substring(11).trim();
                    }

                    // Mark VEH_XYZ lines for potential update
                    if (trimmed.startsWith('VEH_XYZ')) {
                        pendingXYZLineIndex = i;
                        continue;
                    }

                    // Extract command from EVENT_CMND_* lines
                    if (trimmed.startsWith('EVENT_CMND_HOLD_CUE') ||
                        trimmed.startsWith('EVENT_CMND_CUE') ||
                        trimmed.startsWith('EVENT_CMND_UP') ||
                        trimmed.startsWith('EVENT_CMND_DOWN') ||
                        trimmed.startsWith('EVENT_CMND_ONCE')) {

                        const parts = trimmed.split(/\s+/);
                        if (parts.length >= 2) {
                            currentCommand = parts.slice(1).join(' ');

                            // Check for match if we have a pending XYZ line
                            if (currentCommand && pendingXYZLineIndex !== null) {
                                if (commandMap.has(currentCommand)) {
                                    const newXYZ = commandMap.get(currentCommand);

                                    // Get old XYZ to see if it actually changed
                                    const oldLine = lines[pendingXYZLineIndex];
                                    const oldParts = oldLine.trim().substring(8).split(/\s+/);
                                    const oldXYZ = [parseFloat(oldParts[0]), parseFloat(oldParts[1]), parseFloat(oldParts[2])];

                                    // Simple distance check to avoid 0.000 vs -0.000 diffs or negligible changes
                                    const isDifferent =
                                        Math.abs(oldXYZ[0] - newXYZ[0]) > 0.001 ||
                                        Math.abs(oldXYZ[1] - newXYZ[1]) > 0.001 ||
                                        Math.abs(oldXYZ[2] - newXYZ[2]) > 0.001;

                                    if (isDifferent) {
                                        changes.push({
                                            id: changes.length,
                                            command: currentCommand,
                                            eventName: currentEventName,
                                            lineIndex: pendingXYZLineIndex,
                                            oldLine: oldLine, // Keep indentation
                                            oldXYZ: oldXYZ,
                                            newXYZ: newXYZ,
                                            selected: true // Default to checked
                                        });
                                    }

                                    matched++;
                                    pendingXYZLineIndex = null;
                                } else {
                                    if (!unmatched.includes(currentCommand)) {
                                        unmatched.push(currentCommand);
                                    }
                                }
                            }
                        }
                    }
                }

                return {
                    changes,
                    totalEntries,
                    matched,
                    unmatched
                };
            }
        }

        class SNDGenerator {
            constructor(templateContent) {
                this.template = templateContent;
            }

            getDefaultHeader() {
                return `A
1000
ACF_SOUNDS

#################################################
# Generated Sound Bank                          #
# Auto-generated by XPlane SND Generator        #
# ${new Date().toISOString()}                   #
#################################################

DISABLE_LEGACY_ALERT_SOUNDS

`;
            }

            getHeader() {
                if (!this.template) return this.getDefaultHeader();
                const idx = this.template.indexOf('BEGIN_SOUND_ATTACHMENT');
                if (idx > 0) return this.template.substring(0, idx);
                return this.getDefaultHeader();
            }

            generateTemplateSounds(templateSounds) {
                let output = '';

                if (templateSounds.engine) {
                    output += `# Engine Sound
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/engine/running
\tVEH_PART engine 0
\tPARAM_DREF_IDX 0
\tEVENT_START_COND sim/flightmodel2/engines/engine_rotation_speed_rad_sec[0] > 1
\tEVENT_END_COND sim/flightmodel2/engines/engine_rotation_speed_rad_sec[0] < 1
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.propeller) {
                    output += `# Propeller Sound
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/propeller/running
\tVEH_PART prop 0
\tPARAM_DREF_IDX 0
\tEVENT_START_COND sim/flightmodel2/engines/prop_rotation_speed_rad_sec[0] > 1
\tEVENT_END_COND sim/flightmodel2/engines/prop_rotation_speed_rad_sec[0] < 1
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.jet) {
                    output += `# Jet Engine Sound
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/jet/engine
\tVEH_PART engine 0
\tPARAM_DREF_IDX 0
\tEVENT_START_COND sim/flightmodel2/engines/N1_percent[0] > 5
\tEVENT_END_COND sim/flightmodel2/engines/N1_percent[0] < 5
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.reverser) {
                    output += `# Thrust Reverser
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/reversers/deploy
\tVEH_PART engine 0
\tEVENT_START_COND sim/flightmodel2/engines/thrust_reverser_deploy_ratio[0] > 0.1
\tEVENT_END_COND sim/flightmodel2/engines/thrust_reverser_deploy_ratio[0] < 0.1
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.gear) {
                    output += `# Landing Gear Extension
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/gear/extension
\tVEH_XYZ 0.000 0.000 0.000
\tEVENT_START_COND sim/flightmodel2/gear/deploy_ratio[0] > 0
\tEVENT_END_COND sim/flightmodel2/gear/deploy_ratio[0] == 0 OR sim/flightmodel2/gear/deploy_ratio[0] == 1
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.tires) {
                    output += `# Tire Squeal on Landing
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/tires/squeal
\tVEH_XYZ 0.000 -1.000 0.000
\tEVENT_START_COND sim/flightmodel2/gear/tire_vertical_deflection_mtr[0] > 0.01
\tEVENT_END_COND sim/flightmodel2/gear/on_ground[0] == 0
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.groundRoll) {
                    output += `# Ground Roll Rumble
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/ground/rumble
\tVEH_XYZ 0.000 0.000 0.000
\tEVENT_START_COND sim/flightmodel2/gear/on_ground[0] == 1 AND sim/flightmodel/position/groundspeed > 5
\tEVENT_END_COND sim/flightmodel2/gear/on_ground[0] == 0 OR sim/flightmodel/position/groundspeed < 5
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.brakes) {
                    output += `# Brake Squeal
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/brakes/squeal
\tVEH_XYZ 0.000 -0.500 0.000
\tEVENT_START_COND sim/cockpit2/controls/parking_brake_ratio > 0.5 AND sim/flightmodel/position/groundspeed > 1
\tEVENT_END_COND sim/cockpit2/controls/parking_brake_ratio < 0.5 OR sim/flightmodel/position/groundspeed < 1
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.flaps) {
                    output += `# Flaps Extension
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/flaps/extension
\tVEH_XYZ 0.000 0.000 2.000
\tEVENT_START_COND sim/flightmodel2/controls/flap_handle_deploy_ratio > 0
\tEVENT_END_COND sim/flightmodel2/wing/flap1_deg[0] == sim/aircraft/overflow/acf_flap_detents[0] OR sim/flightmodel2/wing/flap1_deg[0] == 0
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.spoilers) {
                    output += `# Spoilers/Speedbrakes
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/spoilers/deploy
\tVEH_XYZ 0.000 0.000 1.000
\tEVENT_START_COND sim/flightmodel2/controls/speedbrake_ratio > 0.1
\tEVENT_END_COND sim/flightmodel2/controls/speedbrake_ratio < 0.1
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.trimWheel) {
                    output += `# Trim Wheel
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/trim/wheel
\tVEH_XYZ 0.000 0.500 0.000
\tEVENT_CMND_CUE sim/flight_controls/pitch_trim_down
END_SOUND_ATTACHMENT

BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/trim/wheel
\tVEH_XYZ 0.000 0.500 0.000
\tEVENT_CMND_CUE sim/flight_controls/pitch_trim_up
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.stallWarning) {
                    output += `# Stall Warning
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/warning/stall
\tVEH_XYZ 0.000 0.500 -0.500
\tEVENT_START_COND sim/flightmodel/failures/stallwarning_on == 1
\tEVENT_END_COND sim/flightmodel/failures/stallwarning_on == 0
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.gearWarning) {
                    output += `# Gear Warning Horn
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/warning/gear_horn
\tVEH_XYZ 0.000 0.500 -0.500
\tEVENT_START_COND sim/cockpit2/annunciators/gear_warning == 1
\tEVENT_END_COND sim/cockpit2/annunciators/gear_warning == 0
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.overspeed) {
                    output += `# Overspeed Warning
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/warning/overspeed
\tVEH_XYZ 0.000 0.500 -0.500
\tEVENT_START_COND sim/flightmodel/failures/over_vne == 1
\tEVENT_END_COND sim/flightmodel/failures/over_vne == 0
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.masterWarning) {
                    output += `# Master Warning/Caution
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/warning/master_warning
\tVEH_XYZ 0.000 0.500 -0.500
\tEVENT_START_COND sim/cockpit2/annunciators/master_warning == 1
\tEVENT_END_COND sim/cockpit2/annunciators/master_warning == 0
END_SOUND_ATTACHMENT

BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/warning/master_caution
\tVEH_XYZ 0.000 0.500 -0.500
\tEVENT_START_COND sim/cockpit2/annunciators/master_caution == 1
\tEVENT_END_COND sim/cockpit2/annunciators/master_caution == 0
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.wind) {
                    output += `# Wind Noise
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/environment/wind
\tVEH_XYZ 0.000 0.500 0.000
\tEVENT_START_COND sim/flightmodel/position/indicated_airspeed > 30
\tEVENT_END_COND sim/flightmodel/position/indicated_airspeed < 30
END_SOUND_ATTACHMENT

`;
                }

                if (templateSounds.rain) {
                    output += `# Rain on Canopy
BEGIN_SOUND_ATTACHMENT
\tEVENT_NAME /aircraft/environment/rain
\tVEH_XYZ 0.000 1.000 0.000
\tEVENT_START_COND sim/weather/rain_percent > 0.1
\tEVENT_END_COND sim/weather/rain_percent < 0.1
END_SOUND_ATTACHMENT

`;
                }

                return output;
            }

            generate(manipulators, eventName, useHoldCue, duplicateForRelease, templateSounds) {
                let output = this.getHeader();

                output += "# Template Sound Blocks\n";
                output += "#############################################################################################\n";
                output += this.generateTemplateSounds(templateSounds);
                output += "\n";

                output += "# Manipulator Sounds\n";
                output += "#############################################################################################\n";

                const seenCommands = new Set();

                for (const manip of manipulators) {
                    if (seenCommands.has(manip.command)) continue;
                    seenCommands.add(manip.command);

                    if (manip.tooltip) {
                        output += `# ${manip.tooltip}\n`;
                    }

                    output += 'BEGIN_SOUND_ATTACHMENT\n';
                    output += `\tEVENT_NAME ${eventName}\n`;
                    output += `\tVEH_XYZ ${manip.xyz[0].toFixed(3)} ${manip.xyz[1].toFixed(3)} ${manip.xyz[2].toFixed(3)}\n`;

                    if (useHoldCue) {
                        output += `\tEVENT_CMND_HOLD_CUE ${manip.command}\n`;
                    } else {
                        output += `\tEVENT_CMND_CUE ${manip.command}\n`;
                    }

                    output += 'END_SOUND_ATTACHMENT\n\n';

                    if (duplicateForRelease) {
                        output += `# ${manip.tooltip || manip.command} - Release\n`;
                        output += 'BEGIN_SOUND_ATTACHMENT\n';
                        output += `\tEVENT_NAME ${eventName}\n`;
                        output += `\tVEH_XYZ ${manip.xyz[0].toFixed(3)} ${manip.xyz[1].toFixed(3)} ${manip.xyz[2].toFixed(3)}\n`;
                        output += `\tEVENT_CMND_UP ${manip.command}\n`;
                        output += 'END_SOUND_ATTACHMENT\n\n';
                    }
                }

                return output;
            }
        }

        class SNDEventParser {
            constructor(sndContent) {
                this.content = sndContent;
            }

            extractEvents() {
                const lines = this.content.split('\n');
                const events = new Set();

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('EVENT_NAME')) {
                        const parts = trimmed.split(/\s+/);
                        if (parts.length >= 2) {
                            const eventPath = parts.slice(1).join(' ');
                            if (eventPath.startsWith('/')) {
                                events.add(eventPath);
                            }
                        }
                    }
                }

                return Array.from(events).sort();
            }
        }

        class FMODPackageBuilder {
            constructor(packageName, createPlaceholders, includeReadme) {
                this.packageName = packageName;
                this.createPlaceholders = createPlaceholders;
                this.includeReadme = includeReadme;
                this.stats = {
                    folders: 0,
                    files: 0
                };
            }

            async build(events) {
                const zip = new JSZip();

                // Create folder structure for each event
                for (const eventPath of events) {
                    // Convert /aircraft/generic/switch to aircraft/generic/switch/
                    const cleanPath = eventPath.substring(1); // Remove leading /
                    const parts = cleanPath.split('/');
                    const eventName = parts[parts.length - 1] || 'event';
                    const folderPath = cleanPath;

                    // Create folder
                    const folder = zip.folder(folderPath);
                    this.stats.folders++;

                    // Create placeholder audio file if requested
                    if (this.createPlaceholders) {
                        // Create minimal WAV file header (empty 1 second mono 44.1kHz)
                        const wavData = this.createEmptyWav();
                        folder.file(`${eventName}.wav`, wavData);
                        this.stats.files++;
                    }

                    // Create event metadata file
                    const metadata = {
                        eventPath: eventPath,
                        eventName: eventName,
                        generatedBy: 'X-Plane SND Generator',
                        timestamp: new Date().toISOString(),
                        note: 'Replace placeholder audio with your actual sound file'
                    };
                    folder.file('_event_info.json', JSON.stringify(metadata, null, 2));
                    this.stats.files++;
                }

                // Create README if requested
                if (this.includeReadme) {
                    const readme = this.generateReadme(events);
                    zip.file('README.txt', readme);
                    this.stats.files++;
                }

                // Create structure map
                const structureMap = this.generateStructureMap(events);
                zip.file('_STRUCTURE_MAP.txt', structureMap);
                this.stats.files++;

                // Generate ZIP blob
                return await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
            }

            createEmptyWav() {
                // Create a minimal valid WAV file (1 second of silence, mono, 44.1kHz, 16-bit)
                const sampleRate = 44100;
                const numChannels = 1;
                const bitsPerSample = 16;
                const duration = 1; // 1 second
                const numSamples = sampleRate * duration;
                const dataSize = numSamples * numChannels * (bitsPerSample / 8);
                const fileSize = 44 + dataSize;

                const buffer = new ArrayBuffer(fileSize);
                const view = new DataView(buffer);

                // RIFF header
                this.writeString(view, 0, 'RIFF');
                view.setUint32(4, fileSize - 8, true);
                this.writeString(view, 8, 'WAVE');

                // fmt chunk
                this.writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true); // fmt chunk size
                view.setUint16(20, 1, true); // audio format (PCM)
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true); // byte rate
                view.setUint16(32, numChannels * (bitsPerSample / 8), true); // block align
                view.setUint16(34, bitsPerSample, true);

                // data chunk
                this.writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);

                // Audio data (silence = all zeros, already initialized)

                return buffer;
            }

            writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            generateReadme(events) {
                return `X-PLANE FMOD STUDIO PACKAGE
Generated: ${new Date().toLocaleString()}
Package: ${this.packageName}

===========================================
INSTALLATION INSTRUCTIONS
===========================================

1. Extract this ZIP file
2. Open your FMOD Studio project
3. Navigate to the Events folder in the Events tab
4. Drag and drop the extracted folders into your Events folder
5. Replace placeholder .wav files with your actual audio files
6. Build your FMOD banks

===========================================
FOLDER STRUCTURE
===========================================

This package contains ${events.length} event paths organized into folders:

${events.map(e => `  ${e}`).join('\n')}

===========================================
PLACEHOLDER FILES
===========================================

${this.createPlaceholders ?
                        `Each event folder contains:
  - [event_name].wav - Placeholder audio file (1 second silence)
  - _event_info.json - Event metadata

Replace the .wav files with your actual sound files.
The _event_info.json files are for reference only.` :
                        `Each event folder contains:
  - _event_info.json - Event metadata

Add your .wav audio files to each folder.`}

===========================================
NOTES
===========================================

- Event paths match your .snd file exactly
- File names should match the last segment of the event path
- You can rename audio files within FMOD Studio
- Keep the folder structure intact for proper event mapping

===========================================
EXPERIMENTAL FEATURE
===========================================

This package generator is experimental. Please verify
the folder structure matches your FMOD Studio project
requirements before importing.

For questions or issues, refer to the X-Plane FMOD
documentation or community forums.
`;
            }

            generateStructureMap(events) {
                let output = `FMOD STUDIO EVENT STRUCTURE MAP\n`;
                output += `Generated: ${new Date().toLocaleString()}\n`;
                output += `Package: ${this.packageName}\n`;
                output += `Total Events: ${events.length}\n`;
                output += `\n${'='.repeat(60)}\n\n`;

                // Group events by top-level folder
                const grouped = {};
                for (const event of events) {
                    const parts = event.split('/').filter(p => p);
                    const topLevel = parts[0] || 'root';
                    if (!grouped[topLevel]) grouped[topLevel] = [];
                    grouped[topLevel].push(event);
                }

                for (const [category, paths] of Object.entries(grouped)) {
                    output += `${category}/\n`;
                    for (const path of paths) {
                        const indent = '  '.repeat(path.split('/').length - 2);
                        const name = path.split('/').pop();
                        output += `${indent}├─ ${name}\n`;
                    }
                    output += '\n';
                }

                return output;
            }
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;

            const generateBtn = document.getElementById('generateModeBtn');
            const updateBtn = document.getElementById('updateModeBtn');
            const fmodBtn = document.getElementById('fmodModeBtn');
            const generateContent = document.getElementById('generateContent');
            const updateContent = document.getElementById('updateContent');
            const fmodContent = document.getElementById('fmodContent');
            const modeDesc = document.getElementById('modeDescription');

            // Remove all active states
            generateBtn.classList.remove('active');
            updateBtn.classList.remove('active');
            fmodBtn.classList.remove('active');
            generateContent.classList.add('hidden');
            updateContent.classList.add('hidden');
            fmodContent.classList.add('hidden');

            if (mode === 'generate') {
                generateBtn.classList.add('active');
                generateContent.classList.remove('hidden');
                modeDesc.textContent = 'Generate a complete .snd file from cockpit.obj manipulators with template sound blocks';
            } else if (mode === 'update') {
                updateBtn.classList.add('active');
                updateContent.classList.remove('hidden');
                modeDesc.textContent = 'Update XYZ coordinates in an existing .snd file by matching commands with cockpit.obj manipulators (fixes Blender Y/Z axis flip)';
            } else if (mode === 'fmod') {
                fmodBtn.classList.add('active');
                fmodContent.classList.remove('hidden');
                modeDesc.innerHTML = 'FMOD Documentation, tutorials, and community resources to help you build great sounds for X-Plane.';
            }
        }

        // Event name selector
        document.getElementById('eventName').addEventListener('change', function () {
            const customGroup = document.getElementById('customEventGroup');
            customGroup.classList.toggle('hidden', this.value !== 'custom');
        });

        // File drop zones for GENERATE mode
        setupDropZone('objDropZone', 'objFile', (content, filename) => {
            objFileContent = content;
            showFileInfo('objFileInfo', filename, content.length);
        });

        setupDropZone('templateDropZone', 'templateFile', (content, filename) => {
            templateFileContent = content;
            showFileInfo('templateFileInfo', filename, content.length);
        });

        // File drop zones for UPDATE mode
        let updatedContent = null;

        setupDropZone('objDropZoneUpdate', 'objFileUpdate', (content, filename) => {
            objFileContentUpdate = content;
            showFileInfo('objFileInfoUpdate', filename, content.length);
        });

        setupDropZone('sndDropZone', 'sndFile', (content, filename) => {
            sndFileContent = content;
            showFileInfo('sndFileInfo', filename, content.length);
        });

        // File drop zone for FMOD mode - REMOVED

        function setupDropZone(dropZoneId, inputId, callback) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(inputId);

            if (!dropZone || !fileInput) {
                console.warn(`Skipping setup: Element ${dropZoneId} or ${inputId} not found`);
                return; // Safety check: Exit if elements are not found
            }

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) readFile(file, callback);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) readFile(file, callback);
            });
        }

        function readFile(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => callback(e.target.result, file.name);
            reader.readAsText(file);
        }

        function showFileInfo(elementId, filename, size) {
            const element = document.getElementById(elementId);
            const sizeKB = (size / 1024).toFixed(1);

            let fileType = 'template';
            if (elementId.includes('Update') || elementId.includes('update')) {
                fileType = 'update';
            } else if (elementId.includes('snd') && elementId.includes('Fmod')) {
                fileType = 'fmod';
            } else if (elementId.includes('snd')) {
                fileType = 'snd';
            } else if (elementId === 'objFileInfo') {
                fileType = 'obj';
            }

            element.innerHTML = `
                <div class="file-info">
                    <div>
                        <div class="file-name">
                            <span>✓</span>
                            <span>${filename}</span>
                        </div>
                        <div class="file-size">${sizeKB} KB</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile('${elementId}', '${fileType}')">×</button>
                </div>
            `;
            element.classList.remove('hidden');
        }

        function removeFile(infoId, type) {
            document.getElementById(infoId).classList.add('hidden');
            if (type === 'obj') {
                objFileContent = null;
                document.getElementById('objFile').value = '';
            } else if (type === 'template') {
                templateFileContent = null;
                document.getElementById('templateFile').value = '';
            } else if (type === 'update') {
                objFileContentUpdate = null;
                document.getElementById('objFileUpdate').value = '';
            } else if (type === 'snd') {
                sndFileContent = null;
                document.getElementById('sndFile').value = '';
            } else if (type === 'fmod') {
                sndFileFmodContent = null;
                document.getElementById('sndFileFmod').value = '';
            }
        }

        function log(message, type = 'info', consoleId = 'console') {
            const console = document.getElementById(consoleId);
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole(consoleId = 'console') {
            document.getElementById(consoleId).innerHTML = '';
        }

        function getFilterSettings() {
            return {
                excludeDragAxis: document.getElementById('excludeDragAxis').checked,
                excludeDragXY: document.getElementById('excludeDragXY').checked,
                excludeAxisKnob: document.getElementById('excludeAxisKnob').checked,
                excludeNoop: document.getElementById('excludeNoop').checked
            };
        }

        function getTemplateSoundSettings() {
            return {
                engine: document.getElementById('includeEngine').checked,
                propeller: document.getElementById('includePropeller').checked,
                jet: document.getElementById('includeJet').checked,
                reverser: document.getElementById('includeReverser').checked,
                gear: document.getElementById('includeGear').checked,
                tires: document.getElementById('includeTires').checked,
                groundRoll: document.getElementById('includeGroundRoll').checked,
                brakes: document.getElementById('includeBrakes').checked,
                flaps: document.getElementById('includeFlaps').checked,
                spoilers: document.getElementById('includeSpoilers').checked,
                trimWheel: document.getElementById('includeTrimWheel').checked,
                stallWarning: document.getElementById('includeStallWarning').checked,
                gearWarning: document.getElementById('includeGearWarning').checked,
                overspeed: document.getElementById('includeOverspeed').checked,
                masterWarning: document.getElementById('includeMasterWarning').checked,
                wind: document.getElementById('includeWind').checked,
                rain: document.getElementById('includeRain').checked
            };
        }

        // UPDATE XYZ MODE FUNCTION
        async function updateXYZ() {
            if (!objFileContentUpdate) {
                alert('Please upload a cockpit.obj file!');
                return;
            }
            if (!sndFileContent) {
                alert('Please upload your existing .snd file!');
                return;
            }

            const startTime = performance.now();

            document.getElementById('outputSectionUpdate').classList.remove('hidden');
            clearConsole('consoleUpdate');
            document.getElementById('statsGridUpdate').classList.add('hidden');
            document.getElementById('downloadBtnUpdate').classList.add('hidden');

            const progressBar = document.getElementById('progressBarUpdate');
            const progressFill = document.getElementById('progressFillUpdate');
            progressBar.classList.remove('hidden');
            progressFill.style.width = '10%';

            document.getElementById('updateBtn').disabled = true;

            log('Starting XYZ coordinate update...', 'info', 'consoleUpdate');

            try {
                // Parse OBJ file
                const parser = new OBJParser(objFileContentUpdate);
                const result = parser.parse();

                progressFill.style.width = '40%';
                log(`Parsed ${result.vertices.length} vertices`, 'success', 'consoleUpdate');
                log(`Found ${result.manipulators.length} manipulators`, 'success', 'consoleUpdate');

                // Build command -> XYZ map
                const commandMap = new Map();
                for (const manip of result.manipulators) {
                    if (manip.command && !commandMap.has(manip.command)) {
                        commandMap.set(manip.command, manip.xyz);
                    }
                }

                progressFill.style.width = '60%';
                log('Built command-to-coordinate mapping. Identifying changes...', 'info', 'consoleUpdate');

                // Identify Changes (Don't update yet)
                const updater = new SNDUpdater(sndFileContent);
                let results;

                try {
                    results = updater.identifyChanges(commandMap);
                } catch (err) {
                    console.error('Error identifying changes:', err);
                    log(`Error: ${err.message}`, 'error', 'consoleUpdate');
                    return;
                }

                currentDiffs = results.changes; // Corrected from results.diffs
                const stats = { // Reconstruct stats object based on identifyChanges return
                    totalEntries: results.totalEntries,
                    matched: results.matched,
                    unmatched: results.unmatched
                };

                // Log Results
                log(`Found ${stats.matched} matches and ${stats.unmatched.length} unmatched commands`, 'info', 'consoleUpdate');

                if (currentDiffs.length === 0) {
                    log('No coordinate differences found.', 'success', 'consoleUpdate');
                    progressFill.style.width = '100%';
                    document.getElementById('updateBtn').disabled = false; // Re-enable button
                    setTimeout(() => {
                        progressBar.classList.add('hidden');
                    }, 1000);
                    return;
                }

                log(`Identified ${currentDiffs.length} coordinate updates needed`, 'warning', 'consoleUpdate');

                // Open Compare Modal
                openCompareModal(currentDiffs, stats.totalEntries, stats.matched, stats.unmatched);

                progressFill.style.width = '100%';
                setTimeout(() => {
                    progressBar.classList.add('hidden');
                }, 1000);

            } catch (error) {
                log('ERROR: ' + error.message, 'error', 'consoleUpdate');
                console.error(error);
                progressFill.style.width = '0';
                setTimeout(() => progressBar.classList.add('hidden'), 500);
                document.getElementById('updateBtn').disabled = false; // Re-enable button on error
            }
        }

        // GENERATE MODE FUNCTION (same as before)
        async function generateSND() {
            if (!objFileContent) {
                alert('Please upload a cockpit.obj file first!');
                return;
            }

            const startTime = performance.now();

            document.getElementById('outputSection').classList.remove('hidden');
            clearConsole();
            document.getElementById('statsGrid').classList.add('hidden');
            document.getElementById('downloadBtn').classList.add('hidden');

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.classList.remove('hidden');
            progressFill.style.width = '10%';

            document.getElementById('generateBtn').disabled = true;

            log('Starting generation...', 'info');

            try {
                const parser = new OBJParser(objFileContent);
                const result = parser.parse();

                progressFill.style.width = '30%';
                log(`Found ${result.vertices.length} vertices`, 'success');
                log(`Found ${result.manipulators.length} manipulators`, 'success');

                const filters = getFilterSettings();
                const filteredManips = result.manipulators.filter(manip => {
                    if (filters.excludeDragAxis && manip.manipType === 'drag_axis') return false;
                    if (filters.excludeDragXY && manip.manipType === 'drag_xy') return false;
                    if (filters.excludeAxisKnob && manip.manipType === 'axis_knob') return false;
                    if (filters.excludeNoop && manip.manipType === 'noop') return false;
                    return true;
                });

                const filteredCount = result.manipulators.length - filteredManips.length;
                if (filteredCount > 0) {
                    log(`Filtered out ${filteredCount} manipulators`, 'warning');
                }

                progressFill.style.width = '60%';

                let layoutParent = document.getElementById('parentCategory').value.trim() || 'aircraft';
                let eventName = document.getElementById('eventName').value;

                if (eventName === 'custom') {
                    eventName = document.getElementById('customEventName').value || `/${layoutParent}/generic/switch`;
                } else {
                    // Replace the default "aircraft" root with the user's chosen root
                    eventName = eventName.replace(/^\/aircraft/, `/${layoutParent}`);
                }

                const useHoldCue = document.getElementById('useHoldCue').checked;
                const duplicateForRelease = document.getElementById('duplicateForRelease').checked;
                const outputFilename = document.getElementById('outputName').value || 'output.snd';

                const generator = new SNDGenerator(templateFileContent);
                const templateSounds = getTemplateSoundSettings();
                generatedContent = generator.generate(filteredManips, eventName, useHoldCue, duplicateForRelease, templateSounds);

                progressFill.style.width = '100%';

                const endTime = performance.now();
                const processingTime = Math.round(endTime - startTime);

                log('Generation complete!', 'success');

                const uniqueCommands = new Set(filteredManips.map(m => m.command)).size;
                const templateCount = Object.values(templateSounds).filter(v => v).length;
                const duplicatedCount = duplicateForRelease ? uniqueCommands * 2 : uniqueCommands;
                const totalEntries = duplicatedCount + templateCount;

                document.getElementById('statVertices').textContent = result.vertices.length.toLocaleString();
                document.getElementById('statManipulators').textContent = result.manipulators.length.toLocaleString();
                document.getElementById('statFiltered').textContent = uniqueCommands.toLocaleString();
                document.getElementById('statDuplicated').textContent = duplicatedCount.toLocaleString();
                document.getElementById('statTemplates').textContent = templateCount.toLocaleString();
                document.getElementById('statTotal').textContent = totalEntries.toLocaleString();
                document.getElementById('statTime').textContent = processingTime + 'ms';
                document.getElementById('statsGrid').classList.remove('hidden');

                // Parse generated content into entries and show review modal
                soundEntries = parseSNDToEntries(generatedContent);

                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.classList.remove('hidden');
                downloadBtn.textContent = 'Review & Customize';

                // Use a direct onclick for reliability + logging
                downloadBtn.onclick = function (e) {
                    e.preventDefault();
                    console.log('Button clicked (onclick)! Output:', outputFilename);
                    console.log('Sound Entries count:', soundEntries ? soundEntries.length : 'null');

                    if (!soundEntries || soundEntries.length === 0) {
                        alert('No sound entries generated! Please check the console for parsing errors.');
                        return;
                    }

                    try {
                        openReviewModal(outputFilename);
                    } catch (err) {
                        console.error('CRITICAL: Failed to open modal:', err);
                        alert('Failed to open modal: ' + err.message);
                    }
                };

                log(`Button ready. Entries generated: ${soundEntries.length}`, 'info');

                log(`Generated ${totalEntries} total sound entries - Click "Review & Customize" to edit`, 'info');

                setTimeout(() => {
                    progressBar.classList.add('hidden');
                    progressFill.style.width = '0';
                }, 500);

            } catch (error) {
                log('ERROR: ' + error.message, 'error');
                progressFill.style.width = '0';
                setTimeout(() => progressBar.classList.add('hidden'), 500);
            }

            document.getElementById('generateBtn').disabled = false;
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            const consoleId = currentMode === 'update' ? 'consoleUpdate' : 'console';
            log('Downloaded: ' + filename, 'success', consoleId);
        }

        // ========================================================================
        // REVIEW MODAL FUNCTIONS
        // ========================================================================



        function openReviewModal(filename) {
            console.log('openReviewModal called with:', filename);
            currentFilename = filename;
            try {
                renderReviewModal();
                document.getElementById('reviewModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                console.log('Review modal opened');
            } catch (e) {
                console.error('Error opening review modal:', e);
                alert('Error opening review modal: ' + e.message);
            }
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function renderReviewModal() {
            const body = document.getElementById('reviewBody');
            body.innerHTML = '';

            const filtered = getFilteredEntries();

            filtered.forEach((entry, index) => {
                const card = createEntryCard(entry, index);
                body.appendChild(card);
            });

            updateReviewStats();
        }

        function getFilteredEntries() {
            let entries = soundEntries;

            // Text Search
            if (searchText) {
                const lower = searchText.toLowerCase();
                entries = entries.filter(e =>
                    e.eventName.toLowerCase().includes(lower) ||
                    e.comment.toLowerCase().includes(lower) ||
                    e.command.toLowerCase().includes(lower) ||
                    e.startCond.toLowerCase().includes(lower)
                );
            }

            // Category/Status Filter
            switch (currentFilter) {
                case 'template':
                    return entries.filter(e => e.isTemplate);
                case 'manip':
                    return entries.filter(e => !e.isTemplate);
                case 'deleted':
                    return entries.filter(e => e.deleted);
                case 'pending':
                    return entries.filter(e => !e.deleted && !e.completed);
                case 'completed':
                    return entries.filter(e => !e.deleted && e.completed);
                case 'all':
                default:
                    return entries;
            }
        }

        function updateSearch(val) {
            searchText = val;
            renderReviewModal();
        }

        function toggleEntryComplete(entryId, completed) {
            const entry = soundEntries.find(e => e.id === entryId);
            if (entry) {
                entry.completed = completed;
                renderReviewModal();
            }
        }

        function toggleEntrySelected(entryId, selected) {
            const entry = soundEntries.find(e => e.id === entryId);
            if (entry) {
                entry.selected = selected;
                updateBulkActionsUI();
            }
        }

        function updateBulkActionsUI() {
            const selectedCount = soundEntries.filter(e => e.selected).length;
            document.getElementById('selectedCount').textContent = selectedCount;

            const panel = document.getElementById('bulkActionsPanel');
            if (selectedCount > 0) {
                panel.classList.remove('hidden');

                // Refresh categories in bulk dropdown
                const bulkCat = document.getElementById('bulkCategory');
                bulkCat.innerHTML = `<option value="">Set Category...</option>
                                     <option value="generic">Generic</option>
                                     ${userCategories.map(c => `<option value="${c}">${c}</option>`).join('')}`;
            } else {
                panel.classList.add('hidden');
            }
        }

        function applyBulkUpdate() {
            const selectedEntries = soundEntries.filter(e => e.selected);
            if (selectedEntries.length === 0) return;

            const category = document.getElementById('bulkCategory').value;
            const trigger = document.getElementById('bulkTrigger').value;

            selectedEntries.forEach(entry => {
                if (category) {
                    updateEntryCategory(entry.id, category);
                }
                if (trigger) {
                    entry.triggerType = trigger;
                }
            });

            log(`Bulk updated ${selectedEntries.length} entries`, 'success');
            renderReviewModal();
        }

        function updateReviewStats() {
            const total = soundEntries.length;
            const deleted = soundEntries.filter(e => e.deleted).length;
            const active = total - deleted;
            const template = soundEntries.filter(e => e.isTemplate && !e.deleted).length;
            const manip = soundEntries.filter(e => !e.isTemplate && !e.deleted).length;
            const pending = soundEntries.filter(e => !e.deleted && !e.completed).length;
            const completed = soundEntries.filter(e => !e.deleted && e.completed).length;

            document.getElementById('totalEntries').textContent = total;
            document.getElementById('activeEntries').textContent = active;
            document.getElementById('deletedEntries').textContent = deleted;
            document.getElementById('countAll').textContent = total;
            document.getElementById('countTemplate').textContent = template;
            document.getElementById('countManip').textContent = manip;
            document.getElementById('countDeleted').textContent = deleted;

            // New counters
            if (document.getElementById('countPending')) document.getElementById('countPending').textContent = pending;
            if (document.getElementById('countCompleted')) document.getElementById('countCompleted').textContent = completed;
        }

        function createEntryCard(entry) {
            const card = document.createElement('div');
            const isCompleted = entry.completed;
            const isSelected = entry.selected;

            card.className = `sound-entry ${entry.deleted ? 'deleted' : ''} ${isCompleted ? 'completed' : ''}`;
            card.id = `entry-${entry.id}`;

            if (entry.deleted) {
                card.innerHTML = `
                    <div class="entry-header">
                        <div class="entry-title" style="text-decoration: line-through; opacity: 0.6;">${escapeHtml(entry.comment || entry.eventName)}</div>
                        <div class="entry-controls">
                            <button class="entry-btn restore" onclick="restoreEntry('${entry.id}'); event.stopPropagation();">Restore</button>
                        </div>
                    </div>
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                        This entry will not be included in the final .snd file. Click "Restore" to add it back.
                    </div>
                `;
                return card;
            }

            card.innerHTML = `
                <div class="entry-header">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" class="entry-select-checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onchange="toggleEntrySelected('${entry.id}', this.checked)">
                        <div class="entry-title">${escapeHtml(entry.comment || entry.eventName)}</div>
                    </div>
                    <div class="entry-controls">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; cursor: pointer; margin-right: 1rem;">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleEntryComplete('${entry.id}', this.checked)">
                            Mark Complete
                        </label>
                        <button class="entry-btn delete" onclick="deleteEntry('${entry.id}')">Delete</button>
                    </div>
                </div>
                
                <div class="entry-grid">
                    <div class="entry-field">
                        <label class="entry-label">Category</label>
                        <select class="entry-select" onchange="updateEntryCategory('${entry.id}', this.value)">
                            <option value="generic">Generic</option>
                            ${userCategories.map(c => `<option value="${c}" ${c === getCategoryFromEvent(entry.eventName) ? 'selected' : ''}>${c}</option>`).join('')}
                            <option value="custom">Custom (Type below)</option>
                        </select>
                    </div>

                    <div class="entry-field">
                        <label class="entry-label">Event Name</label>
                        <input type="text" class="entry-input" data-field="eventName" value="${escapeHtml(entry.eventName)}" 
                               onchange="updateEntryField('${entry.id}', 'eventName', this.value)">
                    </div>
                    
                    <div class="entry-field">
                        <label class="entry-label">Trigger Type</label>
                        <select class="entry-select" onchange="updateEntryField('${entry.id}', 'triggerType', this.value); renderReviewModal();">
                            <option value="EVENT_START_COND" ${entry.triggerType === 'EVENT_START_COND' ? 'selected' : ''}>Start/End Condition</option>
                            <option value="EVENT_CMND_DOWN" ${entry.triggerType === 'EVENT_CMND_DOWN' ? 'selected' : ''}>Command Pressed</option>
                            <option value="EVENT_CMND_UP" ${entry.triggerType === 'EVENT_CMND_UP' ? 'selected' : ''}>Command Released</option>
                            <option value="EVENT_CMND_HOLD_STOP" ${entry.triggerType === 'EVENT_CMND_HOLD_STOP' ? 'selected' : ''}>Hold to Play</option>
                            <option value="EVENT_CMND_HOLD_CUE" ${entry.triggerType === 'EVENT_CMND_HOLD_CUE' ? 'selected' : ''}>Press & Release Cue</option>
                            <option value="CUE_TRIGGER_COND" ${entry.triggerType === 'CUE_TRIGGER_COND' ? 'selected' : ''}>Cue Trigger</option>
                        </select>
                    </div>
                    
                    ${getTriggerFields(entry)}
                    
                    <div class="entry-field full-width">
                        <label class="entry-label">Auto-End Condition (Optional)</label>
                        <input type="text" class="entry-input" value="${escapeHtml(entry.autoEndCond)}" 
                               onchange="updateEntryField('${entry.id}', 'autoEndCond', this.value)"
                               placeholder="e.g., sim/flightmodel/gear/deploy_ratio[0] == 1">
                    </div>
                    
                    <div class="entry-field">
                        <label class="entry-label">XYZ Coordinates</label>
                        <input type="text" class="entry-input" value="${entry.xyz.map(v => v.toFixed(3)).join(', ')}" readonly style="opacity: 0.6;">
                    </div>
                    
                    <div class="entry-field">
                        <label class="entry-label">Advanced Options</label>
                        <div class="entry-checkbox-group">
                            <div class="entry-checkbox">
                                <input type="checkbox" id="poly-${entry.id}" ${entry.polyphonic ? 'checked' : ''}
                                       onchange="updateEntryField('${entry.id}', 'polyphonic', this.checked)">
                                <label for="poly-${entry.id}">Polyphonic</label>
                            </div>
                            <div class="entry-checkbox">
                                <input type="checkbox" id="ai-${entry.id}" ${entry.allowedForAI ? 'checked' : ''}
                                       onchange="updateEntryField('${entry.id}', 'allowedForAI', this.checked)">
                                <label for="ai-${entry.id}">Allowed for AI</label>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // Helper to extract category for pre-selection
        function getCategoryFromEvent(eventName) {
            const parts = eventName.split('/');
            if (parts.length > 2) return parts[2];
            return 'generic';
        }

        function getTriggerFields(entry) {
            switch (entry.triggerType) {
                case 'EVENT_START_COND':
                    return `
                        <div class="entry-field full-width">
                            <label class="entry-label">Start Condition (Dataref)</label>
                            <input type="text" class="entry-input" value="${escapeHtml(entry.startCond)}" 
                                   onchange="updateEntryField('${entry.id}', 'startCond', this.value)"
                                   placeholder="e.g., sim/flightmodel/engine/ENGN_running[0] == 1">
                        </div>
                        <div class="entry-field full-width">
                            <label class="entry-label">End Condition (Dataref)</label>
                            <input type="text" class="entry-input" value="${escapeHtml(entry.endCond)}" 
                                   onchange="updateEntryField('${entry.id}', 'endCond', this.value)"
                                   placeholder="e.g., sim/flightmodel/engine/ENGN_running[0] == 0">
                        </div>
                    `;
                case 'EVENT_CMND_DOWN':
                case 'EVENT_CMND_UP':
                case 'EVENT_CMND_HOLD_STOP':
                case 'EVENT_CMND_HOLD_CUE':
                    return `
                        <div class="entry-field full-width">
                            <label class="entry-label">Command</label>
                            <input type="text" class="entry-input" value="${escapeHtml(entry.command)}" 
                                   onchange="updateEntryField('${entry.id}', 'command', this.value)"
                                   placeholder="e.g., sim/flight_controls/landing_gear_toggle">
                        </div>
                    `;
                case 'CUE_TRIGGER_COND':
                    return `
                        <div class="entry-field full-width">
                            <label class="entry-label">Cue Trigger Condition (Dataref)</label>
                            <input type="text" class="entry-input" value="${escapeHtml(entry.cueTrigger)}" 
                                   onchange="updateEntryField('${entry.id}', 'cueTrigger', this.value)"
                                   placeholder="e.g., sim/cockpit2/gauges/indicators/altitude_ft_pilot < 500">
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function updateEntryField(entryId, field, value) {
            const entry = soundEntries.find(e => e.id === entryId);
            if (entry) {
                entry[field] = value;
                updateReviewStats();
            }
        }

        function deleteEntry(entryId) {
            const entry = soundEntries.find(e => e.id === entryId);
            if (entry) {
                entry.deleted = true;
                renderReviewModal();
            }
        }

        function restoreEntry(entryId) {
            const entry = soundEntries.find(e => e.id === entryId);
            if (entry) {
                entry.deleted = false;
                renderReviewModal();
            }
        }

        function filterEntries(filter) {
            currentFilter = filter;

            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            renderReviewModal();
        }

        function downloadReviewedSND() {
            const header = generatedContent.split('BEGIN_SOUND_ATTACHMENT')[0];
            let content = header;

            soundEntries
                .filter(entry => !entry.deleted)
                .forEach(entry => {
                    content += entry.toSND();
                });

            downloadFile(content, currentFilename);
            closeReviewModal();

            log(`Downloaded customized .snd file with ${soundEntries.filter(e => !e.deleted).length} entries`, 'success');
        }

        // CATEGORY MANAGEMENT
        function addCategory() {
            const input = document.getElementById('categoryInput');
            const category = input.value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');

            if (category && !userCategories.includes(category)) {
                userCategories.push(category);
                input.value = '';
                renderCategories();
            } else if (userCategories.includes(category)) {
                alert('Category already exists!');
            }
        }

        function removeCategory(index) {
            userCategories.splice(index, 1);
            renderCategories();
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            if (!list) return; // Guard if UI not present

            list.innerHTML = userCategories.map((cat, i) => `
                <div class="category-chip">
                    ${cat}
                    <span onclick="removeCategory(${i})" style="cursor:pointer; margin-left:5px;">&times;</span>
                </div>
            `).join('');
        }

        function updateEntryCategory(entryId, category) {
            const entry = soundEntries.find(e => e.id === entryId);
            if (!entry) return;

            if (category === 'custom') {
                return; // Do nothing, let user edit manually
            }

            // Replace current "folder" in path
            // Assuming format /aircraft/FOLDER/name or /aircraft/name

            let parts = entry.eventName.split('/');
            // Standard path: ["", "aircraft", "generic", "name"] -> length 4

            if (category === 'generic') {
                // Reset to generic if possible, or just replace current category section
                if (parts.length >= 4) {
                    parts[2] = 'generic';
                    const newName = parts.join('/');
                    updateEntryField(entryId, 'eventName', newName);
                    // Also update the input field visually
                    const input = document.querySelector(`#entry-${entryId} input[data-field="eventName"]`);
                    if (input) input.value = newName;
                }
            } else {
                if (parts.length >= 4) {
                    parts[2] = category;
                    const newName = parts.join('/');
                    updateEntryField(entryId, 'eventName', newName);
                    // Also update the input field visually
                    const input = document.querySelector(`#entry-${entryId} input[data-field="eventName"]`);
                    if (input) input.value = newName;
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // OBJ Parser (same as before)

        // COMPARE MODAL FUNCTIONS (NEW)


        function openCompareModal(diffs, totalEntries, matched, unmatched) {
            currentDiffs = diffs;
            document.getElementById('compareTotalChanges').textContent = diffs.length;
            document.getElementById('compareSelectedCount').textContent = diffs.length;
            document.getElementById('compareSelectAll').checked = true;

            // Store stats for later
            currentDiffs.stats = { totalEntries, matched, unmatched };

            renderCompareTable();
            document.getElementById('compareModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCompareModal() {
            document.getElementById('compareModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('updateBtn').disabled = false;
        }

        function renderCompareTable() {
            const tbody = document.getElementById('compareBody');
            tbody.innerHTML = '';

            if (currentDiffs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">No changes found.</td></tr>';
                return;
            }

            currentDiffs.forEach(diff => {
                const tr = document.createElement('tr');
                tr.className = `compare-row ${diff.selected ? '' : 'deselected'}`;

                tr.innerHTML = `
                    <td>
                        <input type="checkbox" ${diff.selected ? 'checked' : ''} 
                               onchange="toggleDiff(${diff.id}, this.checked)">
                    </td>
                    <td>
                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 2px;">${escapeHtml(diff.eventName)}</div>
                        <div style="font-size: 0.8rem; font-family: monospace; background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 3px; display: inline-block;">${escapeHtml(diff.command)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">Line ${diff.lineIndex + 1}</div>
                    </td>
                    <td>
                        <div style="margin-bottom: 4px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted); display: inline-block; width: 30px;">OLD:</span>
                            <span class="diff-old" style="display: inline;">
                                ${diff.oldXYZ[0].toFixed(3)}, ${diff.oldXYZ[1].toFixed(3)}, ${diff.oldXYZ[2].toFixed(3)}
                            </span>
                        </div>
                        <div>
                            <span style="font-size: 0.75rem; color: var(--text-muted); display: inline-block; width: 30px;">NEW:</span>
                            <span class="diff-new" style="display: inline;">
                                ${diff.newXYZ[0].toFixed(3)}, ${diff.newXYZ[1].toFixed(3)}, ${diff.newXYZ[2].toFixed(3)}
                            </span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleDiff(id, checked) {
            const diff = currentDiffs.find(d => d.id === id);
            if (diff) {
                diff.selected = checked;
                renderCompareTable(); // Re-render to update opacity
                updateCompareCounts();
            }
        }

        function toggleAllCompare(checked) {
            currentDiffs.forEach(diff => diff.selected = checked);
            renderCompareTable();
            updateCompareCounts();
        }

        function updateCompareCounts() {
            const selected = currentDiffs.filter(d => d.selected).length;
            document.getElementById('compareSelectedCount').textContent = selected;
        }

        function applyUpdates() {
            const selectedChanges = currentDiffs.filter(d => d.selected);
            const stats = currentDiffs.stats;

            // Apply changes to the original content
            // Need to recreate the updater to access content easily, or just use the global
            const updater = new SNDUpdater(sndFileContent);
            const lines = [...updater.originalLines];

            selectedChanges.forEach(diff => {
                const tabs = diff.oldLine.match(/^\t*/)[0];
                lines[diff.lineIndex] = `${tabs}VEH_XYZ ${diff.newXYZ[0].toFixed(3)} ${diff.newXYZ[1].toFixed(3)} ${diff.newXYZ[2].toFixed(3)}`;
            });

            const updatedContent = lines.join('\n');
            const updatedCount = selectedChanges.length;

            closeCompareModal();

            // Finish the workflow (Update UI with results)
            log('Update complete!', 'success', 'consoleUpdate');
            log(`Updated ${updatedCount} coordinates`, 'success', 'consoleUpdate');

            if (stats.unmatched.length > 0) {
                log(`Warning: ${stats.unmatched.length} commands not found in OBJ`, 'warning', 'consoleUpdate');
                log('Unmatched commands:', 'warning', 'consoleUpdate');
                stats.unmatched.slice(0, 5).forEach(cmd => {
                    log(`  - ${cmd}`, 'warning', 'consoleUpdate');
                });
                if (stats.unmatched.length > 5) {
                    log(`  ... and ${stats.unmatched.length - 5} more`, 'warning', 'consoleUpdate');
                }
            }

            // Update stats grid
            document.getElementById('statEntriesFound').textContent = stats.totalEntries.toLocaleString();
            document.getElementById('statMatched').textContent = stats.matched.toLocaleString();
            document.getElementById('statUpdated').textContent = updatedCount.toLocaleString();
            document.getElementById('statUnmatched').textContent = stats.unmatched.length.toLocaleString();
            document.getElementById('statsGridUpdate').classList.remove('hidden');

            // Show download button
            const downloadBtn = document.getElementById('downloadBtnUpdate');
            downloadBtn.classList.remove('hidden');
            const outputFilename = document.getElementById('outputNameUpdate').value || 'updated.snd';
            downloadBtn.onclick = () => downloadFile(updatedContent, outputFilename);

            // Hide progress
            const progressBar = document.getElementById('progressBarUpdate');
            const progressFill = document.getElementById('progressFillUpdate');
            setTimeout(() => {
                progressBar.classList.add('hidden');
                progressFill.style.width = '0';
            }, 500);
        }

        // FMOD PACKAGE EXPORT FUNCTION
        async function exportFMODPackage() {
            if (!sndFileFmodContent) {
                alert('Please upload a .snd file!');
                return;
            }

            const startTime = performance.now();

            document.getElementById('outputSectionFmod').classList.remove('hidden');
            clearConsole('consoleFmod');
            document.getElementById('statsGridFmod').classList.add('hidden');
            document.getElementById('downloadBtnFmod').classList.add('hidden');

            const progressBar = document.getElementById('progressBarFmod');
            const progressFill = document.getElementById('progressFillFmod');
            progressBar.classList.remove('hidden');
            progressFill.style.width = '10%';

            document.getElementById('fmodExportBtn').disabled = true;

            log('Starting FMOD package generation...', 'info', 'consoleFmod');

            try {
                // Load JSZip dynamically
                if (typeof JSZip === 'undefined') {
                    log('Loading JSZip library...', 'info', 'consoleFmod');
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                    progressFill.style.width = '20%';
                }

                const packageName = document.getElementById('packageName').value || 'aircraft_sounds';
                const createPlaceholders = document.getElementById('createPlaceholders').checked;
                const includeReadme = document.getElementById('includeReadme').checked;

                progressFill.style.width = '30%';

                // Parse SND file for event names
                const parser = new SNDEventParser(sndFileFmodContent);
                const events = parser.extractEvents();

                log(`Found ${events.length} unique event paths`, 'success', 'consoleFmod');
                progressFill.style.width = '50%';

                // Build FMOD package
                const builder = new FMODPackageBuilder(packageName, createPlaceholders, includeReadme);
                fmodPackageBlob = await builder.build(events);

                progressFill.style.width = '100%';

                const endTime = performance.now();
                const processingTime = Math.round(endTime - startTime);

                log('Package generation complete!', 'success', 'consoleFmod');
                log(`Created ${builder.stats.folders} folders and ${builder.stats.files} files`, 'info', 'consoleFmod');

                // Update stats
                document.getElementById('statEventsFound').textContent = events.length.toLocaleString();
                document.getElementById('statFolders').textContent = builder.stats.folders.toLocaleString();
                document.getElementById('statFiles').textContent = builder.stats.files.toLocaleString();
                document.getElementById('statPackageSize').textContent = (fmodPackageBlob.size / 1024).toFixed(1) + ' KB';
                document.getElementById('statTimeFmod').textContent = processingTime + 'ms';
                document.getElementById('statsGridFmod').classList.remove('hidden');

                // Show download button
                const downloadBtn = document.getElementById('downloadBtnFmod');
                downloadBtn.classList.remove('hidden');
                downloadBtn.onclick = () => {
                    const url = URL.createObjectURL(fmodPackageBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${packageName}_fmod_structure.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    log(`Downloaded: ${packageName}_fmod_structure.zip`, 'success', 'consoleFmod');
                };

                setTimeout(() => {
                    progressBar.classList.add('hidden');
                    progressFill.style.width = '0';
                }, 500);

            } catch (error) {
                log('ERROR: ' + error.message, 'error', 'consoleFmod');
                console.error(error);
                progressFill.style.width = '0';
                setTimeout(() => progressBar.classList.add('hidden'), 500);
            }

            document.getElementById('fmodExportBtn').disabled = false;
        }

        // Helper to load external scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Helper to parse .snd content back into SoundEntry objects
        function parseSNDToEntries(content) {
            const entries = [];
            const lines = content.split('\n');
            let currentEntry = null;
            let currentComment = '';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (!line) continue;

                if (line.startsWith('#')) {
                    currentComment = line.substring(1).trim();
                    continue;
                }

                if (line.startsWith('BEGIN_SOUND_ATTACHMENT')) {
                    currentEntry = new SoundEntry({});
                    currentEntry.comment = currentComment;
                    currentComment = '';
                    continue;
                }

                if (line.startsWith('END_SOUND_ATTACHMENT')) {
                    if (currentEntry) {
                        entries.push(currentEntry);
                        currentEntry = null;
                    }
                    continue;
                }

                if (currentEntry) {
                    const parts = line.split(/\s+/);
                    const key = parts[0];
                    const args = parts.slice(1);
                    const value = args.join(' ');

                    switch (key) {
                        case 'EVENT_NAME':
                            currentEntry.eventName = value;
                            break;
                        case 'VEH_XYZ':
                            currentEntry.xyz = [parseFloat(args[0]), parseFloat(args[1]), parseFloat(args[2])];
                            break;
                        case 'VEH_PART':
                            currentEntry.vehPart = value;
                            break;
                        case 'EVENT_CMND_DOWN':
                            currentEntry.triggerType = 'EVENT_CMND_DOWN';
                            currentEntry.command = value;
                            break;
                        case 'EVENT_CMND_UP':
                            currentEntry.triggerType = 'EVENT_CMND_UP';
                            currentEntry.command = value;
                            break;
                        case 'EVENT_CMND_HOLD_STOP':
                            currentEntry.triggerType = 'EVENT_CMND_HOLD_STOP';
                            currentEntry.command = value;
                            break;
                        case 'EVENT_CMND_HOLD_CUE':
                            currentEntry.triggerType = 'EVENT_CMND_HOLD_CUE';
                            currentEntry.command = value;
                            break;
                        case 'EVENT_START_COND':
                            currentEntry.triggerType = 'EVENT_START_COND';
                            currentEntry.startCond = value;
                            break;
                        case 'EVENT_END_COND':
                            currentEntry.endCond = value;
                            break;
                        case 'EVENT_AUTO_END_FROM_START_COND':
                            currentEntry.autoEndCond = value;
                            break;
                        case 'CUE_TRIGGER_COND':
                            currentEntry.triggerType = 'CUE_TRIGGER_COND';
                            currentEntry.cueTrigger = value;
                            break;
                        case 'EVENT_POLYPHONIC':
                            currentEntry.polyphonic = true;
                            break;
                        case 'EVENT_ALLOWED_FOR_AI':
                            currentEntry.allowedForAI = true;
                            break;
                        case 'PARAM_DREF_IDX':
                            currentEntry.paramDrefIdx = parseInt(value);
                            break;
                    }
                }
            }
            return entries;
        }
        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            console.log('X-FMOD Initializing...');

            // Initialize default category
            userCategories = ['switches', 'knobs', 'buttons', 'warnings'];
            if (typeof renderCategories === 'function') renderCategories();

            log('Ready. Select a mode to begin.', 'info');
        });

    </script>
</body>

</html>
```